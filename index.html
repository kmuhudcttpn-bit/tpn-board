<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TPNå…¬å¸ƒæ¬„</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Microsoft JhengHei',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{background:rgba(255,255,255,.95);padding:20px;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,.1);text-align:center;margin-bottom:20px}
    .header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px}
    .tabs{display:flex;background:rgba(255,255,255,.9);border-radius:15px;padding:5px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .tab{flex:1;padding:15px;text-align:center;cursor:pointer;border-radius:10px;transition:all .3s ease;font-weight:bold;color:#666}
    .tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;transform:translateY(-2px);box-shadow:0 4px 15px rgba(102,126,234,.4)}
    .tab-content{display:none;background:rgba(255,255,255,.95);border-radius:15px;padding:25px;box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .tab-content.active{display:block}
    .section{margin-bottom:30px}
    .section h2{color:#2c3e50;border-bottom:3px solid #667eea;padding-bottom:10px;margin-bottom:20px;font-size:1.5em}
    .bulletin-board{display:grid;gap:20px}
    .bulletin-section{background:#f8f9fa;border-radius:10px;padding:20px;border-left:5px solid #667eea}
    .bulletin-section h3{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
    .bulletin-item{background:#fff;padding:15px;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:flex-start}
    .bulletin-content{flex:1}
    .bulletin-author{font-weight:bold;color:#667eea;margin-bottom:5px;font-style:normal}
    .bulletin-text{color:#555;line-height:1.6}
    .bulletin-single-line{color:#555;line-height:1.6;font-style:normal}
    .bulletin-single-line .author{font-weight:bold;color:#667eea;font-style:normal}
    .delete-btn{background:#e74c3c;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:background .3s}
    .delete-btn:hover{background:#c0392b}
    .calendar{background:#f8f9fa;border-radius:10px;padding:20px;margin-top:20px}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .calendar-nav{background:#667eea;color:#fff;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;transition:background .3s}
    .calendar-nav:hover{background:#5a6fd8}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .calendar-day{padding:15px 10px;text-align:center;background:#fff;border-radius:5px;cursor:pointer;transition:all .3s;min-height:60px;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .calendar-day:hover{background:#667eea;color:#fff;transform:translateY(-2px)}
    .calendar-day.other-month{opacity:.3}
    .calendar-day.today{background:#667eea;color:#fff;font-weight:bold}
    .input-form{background:#f8f9fa;padding:25px;border-radius:10px;margin-bottom:20px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#2c3e50}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;transition:border-color .3s}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
    .form-group textarea{min-height:100px;resize:vertical}
    .checkbox-group{display:flex;align-items:center;gap:10px;margin-top:10px}
    .submit-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;transition:transform .3s}
    .submit-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .monster-item{background:#fff;padding:20px;border-radius:10px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .monster-creator{font-weight:bold;color:#667eea;margin-bottom:10px;font-size:1.1em}
    .monster-story{margin-bottom:15px;line-height:1.6;color:#555}
    .monster-tips{background:#e8f4fd;padding:15px;border-radius:8px;border-left:4px solid #667eea}
    .day-name{padding:10px;text-align:center;font-weight:bold;color:#667eea;background:#e8f4fd;border-radius:5px}
    .no-data{text-align:center;color:#888;padding:40px;font-style:italic}
    .calendar-day.today:hover{background:#667eea;color:#fff}
    .task-tag{font-size:10px;background:#667eea;color:#fff;padding:2px 4px;border-radius:3px;margin-top:2px;display:flex;justify-content:space-between;align-items:center;gap:2px}
    .task-tag-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .task-delete-btn{background:#e74c3c;border:none;color:#fff;padding:1px 4px;border-radius:2px;cursor:pointer;font-size:9px;line-height:1}
    .task-delete-btn:hover{background:#c0392b}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¥ TPNå…¬å¸ƒæ¬„</h1>
      <p>åœ˜éšŠå”ä½œè³‡è¨Šä¸­å¿ƒ</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab(0)">ğŸ“‹ å…¬å¸ƒæ¬„</div>
      <div class="tab" onclick="switchTab(1)">ğŸ“… è¡Œäº‹æ›†</div>
      <div class="tab" onclick="switchTab(2)">âœï¸ æˆ‘è¦äº¤ç­</div>
      <div class="tab" onclick="switchTab(3)">âš”ï¸ æˆ‘è¦æ‰“æ€ª</div>
    </div>

    <!-- å…¬å¸ƒæ¬„ -->
    <div class="tab-content active" id="tab-0">
      <div class="section">
        <h2>ğŸ“‹ å…¬å¸ƒæ¬„</h2>
        <div class="bulletin-board" id="bulletinBoard">
          <div class="bulletin-section">
            <h3>ğŸ”¥ ç•¶æ—¥è¨Šæ¯</h3>
            <div id="todayMessages" class="no-data">æš«ç„¡ç•¶æ—¥è¨Šæ¯</div>
          </div>
          <div class="bulletin-section">
            <h3>ğŸ“… æœªä¾†è¨Šæ¯</h3>
            <div id="futureMessages" class="no-data">æš«ç„¡æœªä¾†è¨Šæ¯</div>
          </div>
          <div class="bulletin-section">
            <h3>ğŸ“Œ å¸¸é§è¨Šæ¯</h3>
            <div id="permanentMessages" class="no-data">æš«ç„¡å¸¸é§è¨Šæ¯</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¡Œäº‹æ›† -->
    <div class="tab-content" id="tab-1">
      <div class="section">
        <h2>ğŸ“… è¡Œäº‹æ›†</h2>
        <div class="calendar">
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
            <h3 id="currentMonth"></h3>
            <button class="calendar-nav" onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>
    </div>

    <!-- æˆ‘è¦äº¤ç­ -->
    <div class="tab-content" id="tab-2">
      <div class="section">
        <h2>ğŸ“ æ–°å¢å…¬å‘Šè¨Šæ¯</h2>
        <div class="input-form">
          <div class="form-group">
            <label>å…¬å‘Šè€…</label>
            <input type="text" id="announcer" placeholder="è«‹è¼¸å…¥å…¬å‘Šè€…å§“å"/>
          </div>
          <div class="form-group">
            <label>å…¬å‘Šå…§å®¹</label>
            <textarea id="announcement" placeholder="è«‹è¼¸å…¥å…¬å‘Šå…§å®¹"></textarea>
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="isPermanent" onchange="toggleDateInput()"/>
              <label for="isPermanent">è¨­ç‚ºå¸¸é§å…¬å‘Š</label>
            </div>
          </div>
          <div class="form-group" id="dateGroup">
            <label>è¨Šæ¯æ—¥æœŸ</label>
            <input type="date" id="messageDate"/>
          </div>
          <button class="submit-btn" onclick="addAnnouncement()">ç™¼å¸ƒå…¬å‘Š</button>
        </div>
      </div>

      <div class="section">
        <h2>ğŸ“… æ–°å¢è¡Œäº‹æ›†ä»»å‹™</h2>
        <div class="input-form">
          <div class="form-group">
            <label>ä»»å‹™åç¨±</label>
            <input type="text" id="taskName" placeholder="è«‹è¼¸å…¥ä»»å‹™åç¨±"/>
          </div>
          <div class="form-group">
            <label>é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="startDate"/>
          </div>
          <div class="form-group">
            <label>çµæŸæ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
            <input type="date" id="endDate"/>
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="isRecurring" onchange="toggleRecurringOptions()"/>
              <label for="isRecurring">é‡è¤‡ä»»å‹™</label>
            </div>
          </div>
          <div class="form-group" id="recurringGroup" style="display:none;">
            <label>é‡è¤‡é¡å‹</label>
            <select id="recurringType">
              <option value="">è«‹é¸æ“‡é‡è¤‡é¡å‹</option>
              <option value="monthly-date">æ¯æœˆå›ºå®šæ—¥æœŸ</option>
              <option value="monthly-weekday">æ¯æœˆå›ºå®šç¬¬å¹¾å‘¨çš„æ˜ŸæœŸå¹¾</option>
              <option value="monthly-workday">æ¯æœˆç¬¬ä¸€å€‹å·¥ä½œå¤©</option>
              <option value="weekly">æ¯é€±å›ºå®šæ˜ŸæœŸå¹¾</option>
            </select>
          </div>
          <button class="submit-btn" onclick="addTask()">æ–°å¢ä»»å‹™</button>
        </div>
      </div>
    </div>

    <!-- æˆ‘è¦æ‰“æ€ª -->
    <div class="tab-content" id="tab-3">
      <div class="section">
        <h2>âš”ï¸ æ‰“æ€ªå€ï¼ˆç¶“é©—åˆ†äº«ï¼‰</h2>
        <div id="monsterDisplay">
          <div class="no-data">æš«ç„¡æ‰“æ€ªç¶“é©—ï¼Œå¿«ä¾†åˆ†äº«ä½ çš„æˆ°é¬¥æ•…äº‹å§ï¼</div>
        </div>
      </div>

      <div class="section">
        <h2>ğŸ‘¹ å¦–é­”å€ï¼ˆæ–°å¢ç¶“é©—ï¼‰</h2>
        <div class="input-form">
          <div class="form-group">
            <label>å‰µå»ºè€…</label>
            <input type="text" id="creator" placeholder="è«‹è¼¸å…¥å‰µå»ºè€…å§“å"/>
          </div>
          <div class="form-group">
            <label>è¡€æ·šå²ï¼ˆå•é¡Œæè¿°ï¼‰</label>
            <textarea id="problem" placeholder="æè¿°é‡åˆ°çš„å•é¡Œæˆ–æŒ‘æˆ°"></textarea>
          </div>
          <div class="form-group">
            <label>éŒ¦å›Šï¼ˆè§£æ±ºæ–¹æ¡ˆï¼‰</label>
            <textarea id="solution" placeholder="åˆ†äº«è§£æ±ºæ–¹æ¡ˆæˆ–ç¶“é©—å¿ƒå¾—"></textarea>
          </div>
          <button class="submit-btn" onclick="addMonster()">åˆ†äº«ç¶“é©—</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebaseï¼šåˆå§‹åŒ–ï¼ˆmoduleï¼‰ -->
  <script type="module">
    import { initializeApp as firebaseInitializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, push, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCMov5jMBWqSaSeRehdwyx2doNLhuptEv0",
      authDomain: "tpn-bulletin-board.firebaseapp.com",
      databaseURL: "https://tpn-bulletin-board-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tpn-bulletin-board",
      storageBucket: "tpn-bulletin-board.appspot.com",
      messagingSenderId: "54003847727",
      appId: "1:54003847727:web:e272a9a607f0ddc867acda",
      measurementId: "G-485KMHSZ4W"
    };

    window.announcements = [];
    window.tasks = [];
    window.monsters = [];
    window.currentDate = new Date();
    window.calendarDate = new Date();

    let listenersInstalled = false;

    async function bootApp() {
      console.log('ğŸ“± é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¨ºæ–·...');
      try {
        console.log('ğŸš€ åˆå§‹åŒ– Firebase...');
        const app = firebaseInitializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseRefs = { ref, push, set, onValue, remove };

        await testFirebaseConnection(db);
        setupFirebaseListeners();
        showConnectionStatus('å·²é€£ç·šåˆ°é›²ç«¯è³‡æ–™åº« ğŸŒ', 'success');
      } catch (err) {
        console.error('ğŸš« Firebase åˆå§‹åŒ–å¤±æ•—ï¼š', err);
        showConnectionStatus('ç„¡æ³•é€£æ¥é›²ç«¯ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼ ğŸ“¡', 'warning');
        loadLocalData();
      }
      updateAllDisplays();
    }

    function testFirebaseConnection(db) {
      return new Promise((resolve, reject) => {
        const testRef = ref(db, '.info/connected');
        const timeout = setTimeout(() => { cleanup(); reject(new Error('Firebase é€£ç·šé€¾æ™‚')); }, 12000);

        const handleSnapshot = (snap) => {
          if (snap.val() === true) {
            clearTimeout(timeout); cleanup();
            console.log('âœ… Firebase é€£ç·šæˆåŠŸ'); resolve(true);
          }
        };
        const handleError = (e) => { clearTimeout(timeout); cleanup(); reject(e); };

        onValue(testRef, handleSnapshot, handleError);
        function cleanup(){ try {/* å¯ç”¨ off() è§£é™¤ç›£è½ */} catch {} }
      });
    }

    function setupFirebaseListeners() {
      if (listenersInstalled) return;
      listenersInstalled = true;

      const { ref, onValue } = window.firebaseRefs;
      const db = window.firebaseDb;

      onValue(ref(db, 'announcements'), (snap) => {
        const data = snap.val();
        window.announcements = data ? Object.entries(data).map(([id, v]) => ({ id, ...v })) : [];
        updateBulletinBoard();
      });

      onValue(ref(db, 'tasks'), (snap) => {
        const data = snap.val();
        window.tasks = data ? Object.entries(data).map(([id, v]) => ({ id, ...v })) : [];
        updateCalendar();
      });

      onValue(ref(db, 'monsters'), (snap) => {
        const data = snap.val();
        window.monsters = data ? Object.entries(data).map(([id, v]) => ({ id, ...v })) : [];
        updateMonsterDisplay();
      });

      console.log('ğŸ§ Firebase ç›£è½å™¨å·²å°±ç·’');
    }

    function showConnectionStatus(message, type) {
      const statusDiv = document.createElement('div');
      statusDiv.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 25px;
        color: #fff; font-weight: bold; z-index: 1000; animation: slideIn .5s ease-out;
        ${type==='success'?'background:linear-gradient(135deg,#4CAF50,#45a049);':''}
        ${type==='warning'?'background:linear-gradient(135deg,#ff9800,#e68900);':''}
        ${type==='info'?'background:linear-gradient(135deg,#2196F3,#1976D2);':''}
      `;
      statusDiv.textContent = message;
      const style = document.createElement('style');
      style.textContent = `@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}`;
      document.head.appendChild(style);
      document.body.appendChild(statusDiv);
      setTimeout(()=>{ statusDiv.style.animation='slideIn .5s ease-out reverse'; setTimeout(()=>statusDiv.remove(),500); },5000);
    }

    function loadLocalData() {
      try{
        const saved = localStorage.getItem('tpnBulletinData');
        if(saved){
          const d = JSON.parse(saved);
          window.announcements = d.announcements || [];
          window.tasks = d.tasks || [];
          window.monsters = d.monsters || [];
        }else{
          loadDemoData();
        }
      }catch{ loadDemoData(); }
    }

    function loadDemoData(){
      window.announcements = [
        { id:'demo1', announcer:'è­·ç†é•·', content:'è«‹æ³¨æ„ä»Šæ—¥æœ‰æ–°çš„TPNé…æ–¹èª¿æ•´', date:new Date().toISOString().split('T')[0], isPermanent:false, timestamp:new Date().toISOString() },
        { id:'demo2', announcer:'è—¥å¸«', content:'è¨˜å¾—æª¢æŸ¥TPNè¢‹çš„ä¿å­˜æœŸé™', date:null, isPermanent:true, timestamp:new Date().toISOString() }
      ];
    }

    window.showConnectionStatus = showConnectionStatus;
    window.loadLocalData = loadLocalData;

    document.addEventListener('DOMContentLoaded', bootApp);
  </script>

  <!-- äº’å‹•/UIï¼ˆé moduleï¼‰ -->
  <script>
    function switchTab(index){
      document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===index));
      document.querySelectorAll('.tab-content').forEach((c,i)=>c.classList.toggle('active',i===index));
    }
    function toggleDateInput(){
      const isPermanent=document.getElementById('isPermanent').checked;
      document.getElementById('dateGroup').style.display=isPermanent?'none':'block';
    }
    function toggleRecurringOptions(){
      const isRecurring=document.getElementById('isRecurring').checked;
      document.getElementById('recurringGroup').style.display=isRecurring?'block':'none';
    }

    function addAnnouncement(){
      const announcer=document.getElementById('announcer').value.trim();
      const announcement=document.getElementById('announcement').value.trim();
      const isPermanent=document.getElementById('isPermanent').checked;
      const messageDate=document.getElementById('messageDate').value;
      if(!announcer||!announcement){ alert('è«‹å¡«å¯«å…¬å‘Šè€…å’Œå…¬å‘Šå…§å®¹'); return; }
      if(!isPermanent && !messageDate){ alert('è«‹é¸æ“‡è¨Šæ¯æ—¥æœŸæˆ–è¨­ç‚ºå¸¸é§å…¬å‘Š'); return; }
      const newAnnouncement={ announcer, content:announcement, date:isPermanent?null:messageDate, isPermanent, timestamp:new Date().toISOString() };
      if(window.firebaseDb){
        const { ref, push } = window.firebaseRefs;
        push(ref(window.firebaseDb,'announcements'), newAnnouncement)
          .then(()=>{ clearAnnouncementForm(); alert('å…¬å‘Šç™¼å¸ƒæˆåŠŸï¼'); })
          .catch((e)=>{ console.error('ç™¼å¸ƒå…¬å‘Šå¤±æ•—:',e); alert('ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); });
      }else{
        newAnnouncement.id=Date.now().toString();
        window.announcements.push(newAnnouncement);
        saveLocalData(); updateBulletinBoard(); clearAnnouncementForm();
        alert('å…¬å‘Šç™¼å¸ƒæˆåŠŸï¼ï¼ˆæœ¬åœ°å„²å­˜ï¼‰');
      }
    }
    function clearAnnouncementForm(){
      document.getElementById('announcer').value='';
      document.getElementById('announcement').value='';
      document.getElementById('isPermanent').checked=false;
      document.getElementById('messageDate').value='';
      toggleDateInput();
    }

    function addTask(){
      const taskName=document.getElementById('taskName').value.trim();
      const startDate=document.getElementById('startDate').value;
      const endDate=document.getElementById('endDate').value;
      const isRecurring=document.getElementById('isRecurring').checked;
      const recurringType=document.getElementById('recurringType').value;
      if(!taskName||!startDate){ alert('è«‹å¡«å¯«ä»»å‹™åç¨±å’Œé–‹å§‹æ—¥æœŸ'); return; }
      if(isRecurring && !recurringType){ alert('è«‹é¸æ“‡é‡è¤‡é¡å‹'); return; }
      const newTask={ name:taskName, startDate, endDate:endDate||startDate, isRecurring, recurringType, timestamp:new Date().toISOString() };
      if(window.firebaseDb){
        const { ref, push } = window.firebaseRefs;
        push(ref(window.firebaseDb,'tasks'), newTask)
          .then(()=>{ clearTaskForm(); alert('ä»»å‹™æ–°å¢æˆåŠŸï¼'); })
          .catch((e)=>{ console.error('æ–°å¢ä»»å‹™å¤±æ•—:',e); alert('æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); });
      }else{
        newTask.id=Date.now().toString();
        window.tasks.push(newTask);
        saveLocalData(); updateCalendar(); clearTaskForm();
        alert('ä»»å‹™æ–°å¢æˆåŠŸï¼ï¼ˆæœ¬åœ°å„²å­˜ï¼‰');
      }
    }
    function clearTaskForm(){
      document.getElementById('taskName').value='';
      document.getElementById('startDate').value='';
      document.getElementById('endDate').value='';
      document.getElementById('isRecurring').checked=false;
      document.getElementById('recurringType').value='';
      toggleRecurringOptions();
    }

    function addMonster(){
      const creator=document.getElementById('creator').value.trim();
      const problem=document.getElementById('problem').value.trim();
      const solution=document.getElementById('solution').value.trim();
      if(!creator||!problem||!solution){ alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'); return; }
      const newMonster={ creator, problem, solution, timestamp:new Date().toISOString() };
      if(window.firebaseDb){
        const { ref, push } = window.firebaseRefs;
        push(ref(window.firebaseDb,'monsters'), newMonster)
          .then(()=>{ clearMonsterForm(); alert('æ‰“æ€ªç¶“é©—åˆ†äº«æˆåŠŸï¼'); })
          .catch((e)=>{ console.error('åˆ†äº«ç¶“é©—å¤±æ•—:',e); alert('åˆ†äº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); });
      }else{
        newMonster.id=Date.now().toString();
        window.monsters.push(newMonster);
        saveLocalData(); updateMonsterDisplay(); clearMonsterForm();
        alert('æ‰“æ€ªç¶“é©—åˆ†äº«æˆåŠŸï¼ï¼ˆæœ¬åœ°å„²å­˜ï¼‰');
      }
    }
    function clearMonsterForm(){
      document.getElementById('creator').value='';
      document.getElementById('problem').value='';
      document.getElementById('solution').value='';
    }

    function updateBulletinBoard(){
      const today=new Date().toISOString().split('T')[0];
      const todayMessages=document.getElementById('todayMessages');
      const futureMessages=document.getElementById('futureMessages');
      const permanentMessages=document.getElementById('permanentMessages');

      const todayAnnouncements = window.announcements.filter(a=>a.date===today);
      const futureAnnouncements = window.announcements.filter(a=>a.date && a.date>today);
      const permanentAnnouncements = window.announcements.filter(a=>a.isPermanent);

      todayMessages.innerHTML = todayAnnouncements.length===0
        ? '<div class="no-data">æš«ç„¡ç•¶æ—¥è¨Šæ¯</div>'
        : todayAnnouncements.map(a=>`
          <div class="bulletin-item">
            <div class="bulletin-content">
              <div class="bulletin-author">${a.announcer}</div>
              <div class="bulletin-text">${a.content}</div>
            </div>
            <button class="delete-btn" onclick="deleteAnnouncement('${a.id}')">åˆªé™¤</button>
          </div>`).join('');

      futureMessages.innerHTML = futureAnnouncements.length===0
        ? '<div class="no-data">æš«ç„¡æœªä¾†è¨Šæ¯</div>'
        : futureAnnouncements.map(a=>`
          <div class="bulletin-item">
            <div class="bulletin-content">
              <div class="bulletin-author">${a.announcer}</div>
              <div class="bulletin-text">${a.content}</div>
            </div>
            <button class="delete-btn" onclick="deleteAnnouncement('${a.id}')">åˆªé™¤</button>
          </div>`).join('');

      permanentMessages.innerHTML = permanentAnnouncements.length===0
        ? '<div class="no-data">æš«ç„¡å¸¸é§è¨Šæ¯</div>'
        : permanentAnnouncements.map(a=>`
          <div class="bulletin-item">
            <div class="bulletin-content">
              <div class="bulletin-single-line"><span class="author">${a.announcer}</span> ${a.content}</div>
            </div>
            <button class="delete-btn" onclick="deleteAnnouncement('${a.id}')">åˆªé™¤</button>
          </div>`).join('');
    }

    function deleteAnnouncement(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—ï¼Ÿ')) return;
      if(window.firebaseDb){
        const { ref, remove } = window.firebaseRefs;
        remove(ref(window.firebaseDb,`announcements/${id}`))
          .then(()=>console.log('å…¬å‘Šåˆªé™¤æˆåŠŸ'))
          .catch((e)=>{ console.error('åˆªé™¤å…¬å‘Šå¤±æ•—:',e); alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); });
      }else{
        window.announcements = window.announcements.filter(a=>a.id!==id);
        saveLocalData(); updateBulletinBoard();
      }
    }

    function updateCalendar(){
      const year=window.calendarDate.getFullYear();
      const month=window.calendarDate.getMonth();
      document.getElementById('currentMonth').textContent = `${year}å¹´${month+1}æœˆ`;

      const firstDay=new Date(year,month,1);
      const startDate=new Date(firstDay);
      startDate.setDate(startDate.getDate()-firstDay.getDay());

      const calendarGrid=document.getElementById('calendarGrid');
      calendarGrid.innerHTML='';

      ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(day=>{
        const el=document.createElement('div'); el.className='day-name'; el.textContent=day; calendarGrid.appendChild(el);
      });

      for(let i=0;i<42;i++){
        const date=new Date(startDate); date.setDate(startDate.getDate()+i);
        const dayEl=document.createElement('div'); dayEl.className='calendar-day';
        if(date.getMonth()!==month) dayEl.classList.add('other-month');
        if(date.toDateString()===new Date().toDateString()) dayEl.classList.add('today');
        dayEl.innerHTML=`<div>${date.getDate()}</div>`;

        const dateStr=formatDateStr(date);
        const dayTasks=window.tasks.filter(t=>{
          if(!t.isRecurring){
            return dateStr>=t.startDate && dateStr<=t.endDate;
          }
          
          const taskStart = new Date(t.startDate + 'T00:00:00');
          if(date < taskStart) return false;
          
          switch(t.recurringType){
            case 'monthly-date':
              return date.getDate() === taskStart.getDate();
            
            case 'monthly-weekday':
              const startWeekOfMonth = Math.ceil(taskStart.getDate() / 7);
              const currentWeekOfMonth = Math.ceil(date.getDate() / 7);
              return date.getDay() === taskStart.getDay() && startWeekOfMonth === currentWeekOfMonth;
            
            case 'monthly-workday':
              if(date.getDay() === 0 || date.getDay() === 6) return false;
              const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
              let firstWorkday = new Date(firstDayOfMonth);
              while(firstWorkday.getDay() === 0 || firstWorkday.getDay() === 6){
                firstWorkday.setDate(firstWorkday.getDate() + 1);
              }
              return date.getDate() === firstWorkday.getDate();
            
            case 'weekly':
              return date.getDay() === taskStart.getDay();
            
            default:
              return false;
          }
        });
        
        dayTasks.forEach(t=>{
          const tEl=document.createElement('div');
          tEl.className='task-tag';
          
          const nameEl=document.createElement('div');
          nameEl.className='task-tag-name';
          nameEl.textContent=t.name;
          
          const delBtn=document.createElement('button');
          delBtn.className='task-delete-btn';
          delBtn.textContent='Ã—';
          delBtn.onclick=(e)=>{ e.stopPropagation(); deleteTask(t.id); };
          
          tEl.appendChild(nameEl);
          tEl.appendChild(delBtn);
          dayEl.appendChild(tEl);
        });

        calendarGrid.appendChild(dayEl);
      }
    }

    function formatDateStr(date){
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function changeMonth(delta){
      window.calendarDate.setMonth(window.calendarDate.getMonth()+delta);
      updateCalendar();
    }

    function updateMonsterDisplay(){
      const container=document.getElementById('monsterDisplay');
      if(window.monsters.length===0){
        container.innerHTML='<div class="no-data">æš«ç„¡æ‰“æ€ªç¶“é©—ï¼Œå¿«ä¾†åˆ†äº«ä½ çš„æˆ°é¬¥æ•…äº‹å§ï¼</div>';
      }else{
        container.innerHTML = window.monsters.map(m=>`
          <div class="monster-item">
            <div class="monster-creator">ğŸ—¡ï¸ ${m.creator}</div>
            <div class="monster-story"><h4>è¡€æ·šå²ï¼š</h4><p>${m.problem}</p></div>
            <div class="monster-tips"><h4>ğŸ’¡ éŒ¦å›Šå¦™è¨ˆï¼š</h4><p>${m.solution}</p></div>
            <button class="delete-btn" onclick="deleteMonster('${m.id}')" style="margin-top:10px;">åˆªé™¤ç¶“é©—</button>
          </div>`).join('');
      }
    }

    function deleteMonster(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ‰“æ€ªç¶“é©—å—ï¼Ÿ')) return;
      if(window.firebaseDb){
        const { ref, remove } = window.firebaseRefs;
        remove(ref(window.firebaseDb,`monsters/${id}`))
          .then(()=>console.log('æ‰“æ€ªç¶“é©—åˆªé™¤æˆåŠŸ'))
          .catch((e)=>{ console.error('åˆªé™¤æ‰“æ€ªç¶“é©—å¤±æ•—:',e); alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); });
      }else{
        window.monsters = window.monsters.filter(m=>m.id!==id);
        saveLocalData(); updateMonsterDisplay();
      }
    }

    function deleteTask(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ')) return;
      if(window.firebaseDb){
        const { ref, remove } = window.firebaseRefs;
        remove(ref(window.firebaseDb,`tasks/${id}`))
          .then(()=>console.log('ä»»å‹™åˆªé™¤æˆåŠŸ'))
          .catch((e)=>{ console.error('åˆªé™¤ä»»å‹™å¤±æ•—:',e); alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); });
      }else{
        window.tasks = window.tasks.filter(t=>t.id!==id);
        saveLocalData(); updateCalendar();
      }
    }

    function formatDate(s){
      if(!s) return '';
      const d=new Date(s);
      return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    }

    function saveLocalData(){
      const data={ announcements:window.announcements, tasks:window.tasks, monsters:window.monsters };
      localStorage.setItem('tpnBulletinData', JSON.stringify(data));
      console.log('è³‡æ–™å·²å„²å­˜è‡³æœ¬åœ°');
    }

    function loadLocalData(){
      try{
        const saved=localStorage.getItem('tpnBulletinData');
        if(saved){
          const d=JSON.parse(saved);
          window.announcements=d.announcements||[];
          window.tasks=d.tasks||[];
          window.monsters=d.monsters||[];
          console.log('å¾æœ¬åœ°è¼‰å…¥è³‡æ–™');
        }else{
          loadDemoData();
        }
      }catch(e){ console.error('è¼‰å…¥æœ¬åœ°è³‡æ–™å¤±æ•—:',e); loadDemoData(); }
    }

    function loadDemoData(){
      window.announcements=[
        { id:'1', announcer:'è­·ç†é•·', content:'è«‹æ³¨æ„ä»Šæ—¥æœ‰æ–°çš„TPNé…æ–¹èª¿æ•´', date:new Date().toISOString().split('T')[0], isPermanent:false, timestamp:new Date().toISOString() },
        { id:'2', announcer:'è—¥å¸«', content:'è¨˜å¾—æª¢æŸ¥TPNè¢‹çš„ä¿å­˜æœŸé™', date:null, isPermanent:true, timestamp:new Date().toISOString() }
      ];
    }

    window.switchTab = switchTab;
    window.toggleDateInput = toggleDateInput;
    window.toggleRecurringOptions = toggleRecurringOptions;
    window.addAnnouncement = addAnnouncement;
    window.addTask = addTask;
    window.addMonster = addMonster;
    window.deleteAnnouncement = deleteAnnouncement;
    window.deleteTask = deleteTask;
    window.deleteMonster = deleteMonster;
    window.updateAllDisplays = function(){ updateCalendar(); updateBulletinBoard(); updateMonsterDisplay(); };
    window.updateBulletinBoard = updateBulletinBoard;
    window.updateCalendar = updateCalendar;
    window.updateMonsterDisplay = updateMonsterDisplay;
    window.changeMonth = changeMonth;

    window.addEventListener('online', ()=> showConnectionStatus && showConnectionStatus('ç¶²è·¯å·²æ¢å¾© ğŸ“¶','success'));
    window.addEventListener('offline',()=> showConnectionStatus && showConnectionStatus('ç¶²è·¯æ–·ç·šï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼ ğŸ“µ','warning'));
  </script>
</body>
</html>
